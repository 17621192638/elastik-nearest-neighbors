<html>
    <head>
        <title>Approximate Vector Search Demo</title>

        <style>
            
            body {
                font-family: Arial;
            }

            #imgs div {
                padding: 5px;
            }
            #imgs img {
                border: gray 8px solid;
            }
            #imgs div:first-of-type > img {
                border: red 8px solid;
            }
            #imgs img {
                height: 300px;
                width: 300px;
            }
            #imgs > div {
                float: left;
            }
        </style>

    </head>

    <body>
        <main>
            <div>
                <h1>Elasticsearch-Aknn Demo</h1>
                <p>The images below consist of a query image (outlined in red)
                    and its 9 nearest neighbors from a feature space                     constructed by running each image through a convolutional
                    neural network and storing the penultimate 1000-dimensional
                    floating-point feature vector.
                </p>
                <p>The convolutional network uses the MobileNet architecture
                    and was trained on the ImageNet dataset.</p>
                <p>The images were collected from the Twitter public stream,
                    and the complete corpus contains <b><span id="corpus_count"></span></b>
                    images.</p>
                <p>Elasticsearch and the Elasticsearch-Aknn plugin are used
                    to store the feature vectors and run the approximate
                    nearest neighbors computation.</p>
            </div>
            <hr/>
            <div>
                <p>Some examples:
                    <a href="/?image_id=988057738172387328">Dogs</a>,
                    <a href="/?image_id=988059982124871680">Cats</a>,
                    <a href="/?image_id=988057805285277696">Food</a>,
                    <a href="/?image_id=988059977922293760">Male Athletes</a>,
                    <a href="/?image_id=988057775908507649">TV Show</a>,
                    <a href="/?image_id=988386617747431424">Comics</a>,
                    <a href="/?image_id=988402744829636608">Greenery</a>,
                    <a href="/?image_id=988059994691006464">Performers</a>,
                    <a href="/?image_id=random">Random</a>
                </p>
            </div>
            <hr/>

            <div id="imgs">
                <p>Please select an example above.</p>
            </div>

        </main>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticsearch/14.2.2/elasticsearch.min.js" type="text/javascript"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="/sample_ids.js"></script>

        <script>

        // Get the param value with the given name from the URL.
        function getURLParam(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        

        var ES_URL = "http://localhost:9200/twitter_images/twitter_image/"
        var S3_URL = "https://s3.amazonaws.com/klibisz-twitter-stream/"

        var count_URL = ES_URL + "_count"
        axios.get(count_URL)
            .then(response => {
                var count = response.data.count
                document.getElementById("corpus_count").innerHTML = count
            })

        var image_id = getURLParam("image_id")
        if (image_id == "random") {
            var random_index = Math.floor(Math.random() * SAMPLE_IDS.length)
            image_id = SAMPLE_IDS[random_index]
        }

        if (image_id != null) {

            var search_URL = ES_URL + image_id + "/_aknn_search?k1=1000&k2=10"

            axios.get(search_URL)
                .then(response => {
                    var hits = response.data.hits.hits
                    var html = hits.map(hit => {
                        var s = '<div>'
                        s += '<img src="' + hit._source.s3_url + '"/>'
                        s += '<p><a href="' + hit._source.twitter_url + '">'
                        s += 'Twitter Status</a>'
                        s += ', ' + Math.round(hit._score * 100) / 100 + '</p>'
                        return s + '</div>'
                    }).join("\n")
                    document.getElementById("imgs").innerHTML = html
                })
                .catch(function (error) {
                    console.log(error);
                });

        }

        </script> 

    </body>

</html>
